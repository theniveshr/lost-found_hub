<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit an Item | Lost & Found Portal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="forms.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* ... (keep all your existing styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML structure) ... -->

    <script>
        // Initialize EmailJS
        emailjs.init("ieCJeX-5LsiuaA20c");

        // Modal functionality for footer links
        const modalBackdrop = document.getElementById('modalBackdrop');
        const privacyModal = document.getElementById('privacyModal');
        const serviceModal = document.getElementById('serviceModal');
        const termsModal = document.getElementById('termsModal');
        const privacyLink = document.getElementById('privacyLink');
        const serviceLink = document.getElementById('serviceLink');
        const termsLink = document.getElementById('termsLink');

        // Open modal functions
        function openModal(modal) {
            modalBackdrop.style.display = 'block';
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }

        function closeModals() {
            modalBackdrop.style.display = 'none';
            privacyModal.style.display = 'none';
            serviceModal.style.display = 'none';
            termsModal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // Event listeners for footer links
        privacyLink.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(privacyModal);
        });

        serviceLink.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(serviceModal);
        });

        termsLink.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(termsModal);
        });

        // Close modals
        modalBackdrop.addEventListener('click', closeModals);
        
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeModals);
        });

        // Close with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModals();
            }
        });

        // Function to update avatars in header
        function updateHeaderAvatars(avatarUrl) {
            const accountIconImage = document.getElementById('accountIconImage');
            const accountIconFallback = document.getElementById('accountIconFallback');
            const dropdownAvatarImage = document.getElementById('dropdownAvatarImage');
            const dropdownAvatarFallback = document.getElementById('dropdownAvatarFallback');
            
            if (avatarUrl && avatarUrl !== '') {
                // Update account icon
                accountIconImage.src = avatarUrl;
                accountIconImage.style.display = 'block';
                accountIconFallback.style.display = 'none';
                
                // Update dropdown avatar
                dropdownAvatarImage.src = avatarUrl;
                dropdownAvatarImage.style.display = 'block';
                dropdownAvatarFallback.style.display = 'none';
            } else {
                // Show fallback icons if no avatar
                accountIconImage.style.display = 'none';
                accountIconFallback.style.display = 'block';
                dropdownAvatarImage.style.display = 'none';
                dropdownAvatarFallback.style.display = 'block';
            }
        }

        // Function to update user info
        function updateUserInfo(username, email) {
            const usernameElement = document.getElementById('username');
            const useremailElement = document.getElementById('useremail');
            
            if (username) {
                usernameElement.textContent = username;
            }
            
            if (email) {
                useremailElement.textContent = email;
            }
        }

        // Function to fetch user profile from database
        async function fetchUserProfile() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('No authentication token found');
                    return null;
                }

                // Fetch user profile from your backend API
                const response = await fetch('http://localhost:3000/api/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user profile');
                }

                const result = await response.json();
                
                if (result.success) {
                    return result.user;
                } else {
                    throw new Error(result.message || 'Failed to fetch user profile');
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        // Toggle account dropdown
        document.getElementById('accountIcon').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('accountDropdown').classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const accountSection = document.getElementById('accountSection');
            if (!accountSection.contains(event.target)) {
                document.getElementById('accountDropdown').classList.remove('active');
            }
        });

        // Mobile menu toggle
        document.getElementById('hamburgerMenu').addEventListener('click', function() {
            document.getElementById('mainNav').classList.toggle('active');
        });

        // Logout functionality
        document.querySelector('.logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            // Clear any stored authentication data
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            // Redirect to login page
            window.location.href = 'login.html';
        });

        // Image preview functionality
        document.getElementById('itemImage').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                }
                
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // Remove image functionality
        document.getElementById('removeImage').addEventListener('click', function() {
            document.getElementById('itemImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        });

        // Function to convert image to base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Form submission handler - FIXED WITH BETTER DEBUGGING
        document.getElementById('itemForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }

            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';

            try {
                // Get form data
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Please login to submit an item');
                }

                // Get all form values
                const itemType = document.querySelector('input[name="itemType"]:checked').value;
                const itemName = document.getElementById('itemName').value.trim();
                const category = document.getElementById('category').value;
                const description = document.getElementById('description').value.trim();
                const location = document.getElementById('location').value.trim();
                const date = document.getElementById('date').value;
                const contactEmail = document.getElementById('contactEmail').value.trim();
                const contactPhone = document.getElementById('contactPhone').value.trim();
                const fileInput = document.getElementById('itemImage');
                const hasImage = !!fileInput.files[0];

                console.log('=== SUBMISSION STARTED ===');
                console.log('Item Type:', itemType);
                console.log('Item Name:', itemName);

                // Collect form data for database
                const formData = new FormData();
                formData.append('itemType', itemType);
                formData.append('itemName', itemName);
                formData.append('category', category);
                formData.append('description', description);
                formData.append('location', location);
                formData.append('date', date);
                formData.append('contactEmail', contactEmail);
                formData.append('contactPhone', contactPhone);
                
                // Add image if exists
                if (fileInput.files[0]) {
                    formData.append('itemImage', fileInput.files[0]);
                }

                // Step 1: Save item to database via API call
                console.log('Saving to database...');
                const dbResponse = await fetch('http://localhost:3000/api/items', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const dbResult = await dbResponse.json();
                
                if (!dbResponse.ok || !dbResult.success) {
                    throw new Error(dbResult.message || 'Failed to save item to database');
                }

                console.log('✓ Database save successful:', dbResult);

                // Step 2: Send email notification
                console.log('Preparing to send email for', itemType, 'item...');
                
                // Create email data with SIMPLE structure
                const emailData = {
                    // Basic fields that should work with any template
                    to_email: "lostnfoundhub1@gmail.com",
                    from_name: "Lost & Found Portal",
                    from_email: contactEmail,
                    subject: `New ${itemType} Item: ${itemName}`,
                    
                    // Template variables
                    item_type: itemType,  // Use snake_case for template
                    item_name: itemName,
                    category: category,
                    description: description,
                    location: location,
                    date: date,
                    contact_email: contactEmail,
                    contact_phone: contactPhone,
                    timestamp: new Date().toLocaleString(),
                    has_image: hasImage ? "Yes" : "No",
                    
                    // For debugging
                    _debug_itemType: itemType,
                    _debug_status: "submitted"
                };

                console.log('Email data prepared:', emailData);

                try {
                    console.log('Attempting to send email via EmailJS...');
                    
                    // Test with a simpler template first
                    const emailResult = await emailjs.send(
                        'service_csp5v7g', 
                        'template_ye5sd7p',  // Your template ID
                        emailData
                    );
                    
                    console.log('✓ Email sent successfully!');
                    console.log('Email result:', {
                        status: emailResult.status,
                        text: emailResult.text
                    });
                    
                } catch (emailError) {
                    console.error('✗ Email sending failed:', emailError);
                    console.error('Error details:', {
                        status: emailError?.status,
                        text: emailError?.text,
                        message: emailError?.message
                    });
                    
                    // Try alternative template if first one fails
                    try {
                        console.log('Trying alternative approach...');
                        
                        // Create simpler email data
                        const simpleEmailData = {
                            to_email: "lostnfoundhub1@gmail.com",
                            from_name: "Lost & Found Portal",
                            from_email: contactEmail,
                            subject: `URGENT: ${itemType} Item Report - ${itemName}`,
                            message: `
                                IMPORTANT: ${itemType.toUpperCase()} ITEM REPORTED
                                
                                Item Details:
                                - Type: ${itemType}
                                - Name: ${itemName}
                                - Category: ${category}
                                - Description: ${description}
                                - Location: ${location}
                                - Date: ${date}
                                
                                Contact Information:
                                - Email: ${contactEmail}
                                - Phone: ${contactPhone}
                                
                                Report Time: ${new Date().toLocaleString()}
                                ${hasImage ? "\nNote: Image was attached to the report." : ""}
                            `
                        };
                        
                        // Try with template_1 if available, or use default
                        const fallbackResult = await emailjs.send(
                            'service_csp5v7g',
                            'template_1',  // Try default template
                            simpleEmailData
                        );
                        
                        console.log('✓ Fallback email sent successfully:', fallbackResult);
                        
                    } catch (fallbackError) {
                        console.error('✗ Fallback email also failed:', fallbackError);
                        // Continue anyway - database save was successful
                    }
                }

                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';

                // Show success modal
                document.getElementById('successModal').style.display = 'flex';

                // Reset form
                document.getElementById('itemForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('date').valueAsDate = new Date();

                console.log('=== SUBMISSION COMPLETED ===');

            } catch (error) {
                console.error('✗ Submission error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (error.message.includes('login') || error.message.includes('token')) {
                    alert('Please login to submit an item');
                    window.location.href = 'login.html';
                } else {
                    alert('Error: ' + error.message);
                }
            }
        });

        // Form validation function
        function validateForm() {
            let isValid = true;

            // Reset error messages
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.style.display = 'none';
            });

            // Validate item type
            const itemType = document.querySelector('input[name="itemType"]:checked');
            if (!itemType) { 
                document.getElementById('itemType-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate item name
            const itemName = document.getElementById('itemName').value.trim();
            if (!itemName) { 
                document.getElementById('itemName-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate category
            const category = document.getElementById('category').value;
            if (!category) { 
                document.getElementById('category-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate description
            const description = document.getElementById('description').value.trim();
            if (!description) { 
                document.getElementById('description-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate location
            const location = document.getElementById('location').value.trim();
            if (!location) { 
                document.getElementById('location-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate date
            const date = document.getElementById('date').value;
            if (!date) { 
                document.getElementById('date-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate email
            const email = document.getElementById('contactEmail').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) { 
                document.getElementById('contactEmail-error').style.display = 'block'; 
                isValid = false; 
            }

            // Validate phone
            const phone = document.getElementById('contactPhone').value.trim();
            const phoneRegex = /^\d{10}$/;
            if (!phone || !phoneRegex.test(phone)) { 
                document.getElementById('contactPhone-error').style.display = 'block'; 
                isValid = false; 
            }

            return isValid;
        }

        // Close success modal when the OK button is clicked
        document.getElementById('successButton').addEventListener('click', function() {
            document.getElementById('successModal').style.display = 'none';
        });

        // Also close modal when clicking outside the modal content
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Test EmailJS function - Add this to test directly from console
        window.testEmailJS = function(itemType = 'Lost') {
            console.log('Testing EmailJS with item type:', itemType);
            
            const testData = {
                to_email: "lostnfoundhub1@gmail.com",
                from_name: "Test User",
                from_email: "test@example.com",
                subject: `TEST ${itemType} Item`,
                item_type: itemType,
                item_name: `Test ${itemType} Item`,
                category: "Electronics",
                description: `This is a test ${itemType.toLowerCase()} item description`,
                location: "Test Location",
                date: "2024-01-15",
                contact_email: "test@example.com",
                contact_phone: "1234567890",
                timestamp: new Date().toLocaleString(),
                has_image: "No"
            };

            emailjs.send('service_csp5v7g', 'template_ye5sd7p', testData)
                .then(response => {
                    console.log(`✓ ${itemType} test email sent:`, response);
                    alert(`${itemType} test email sent successfully! Check your email.`);
                })
                .catch(error => {
                    console.error(`✗ ${itemType} test email failed:`, error);
                    alert(`${itemType} test email failed: ${error.text || error.message}`);
                });
        };

        // Load user profile and check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login to submit an item');
                window.location.href = 'login.html';
                return;
            }

            try {
                // Fetch user profile from database
                const userProfile = await fetchUserProfile();
                
                if (userProfile) {
                    // Update user info with data from database
                    updateUserInfo(
                        userProfile.username || userProfile.name || 'User',
                        userProfile.email || 'user@example.com'
                    );
                    
                    // Store user ID in localStorage
                    if (userProfile.user_id) {
                        localStorage.setItem('userId', userProfile.user_id);
                    }
                    
                    // Update avatar with user's original image from database
                    if (userProfile.avatar) {
                        updateHeaderAvatars(userProfile.avatar);
                    }
                } else {
                    // Fallback to demo data if fetch fails
                    console.log('Using demo data as fallback');
                    updateUserInfo('User', 'user@example.com');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to demo data
                updateUserInfo('User', 'user@example.com');
            }
        });
    </script>
</body>
</html>